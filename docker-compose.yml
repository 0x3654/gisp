name: registry
services:
  postgres_registry:
    image: pgvector/pgvector:pg16
    container_name: pg
    shm_size: "2g"
    env_file: .env
    command: >
      postgres
      -c shared_preload_libraries=pg_prewarm
      -c pg_prewarm.autoprewarm=on
      -c pg_prewarm.autoprewarm_interval=${PG_AUTOPREWARM_INTERVAL:-300}
      -c pg_prewarm.autoprewarm_startup=on
    ports:
      - '5432:5432'
    volumes:
      - ./services/postgres/data:/var/lib/postgresql/data
      - ./services/init:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    networks:
       - internal
       - default
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    container_name: api
    env_file: .env
    ports:
      - '8000:8000'
    depends_on:
      - postgres_registry
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    networks:
        - internal
  import:
    build:
      context: ./services/import
      dockerfile: Dockerfile
    container_name: import
    env_file: .env
    volumes:
      - ./logs:/var/log/registry
      - ./services/import:/import
      - ./files:/files:cached
    depends_on:
      - postgres_registry
      - semantic
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    networks:
      - internal
      - default
  openwebui:
    image: ghcr.io/open-webui/open-webui
    container_name: openwebui
    ports:
      - '3333:8080'
    volumes:
      - ./services/openwebui/data:/app/backend/data
    restart: unless-stopped
    networks:
      - internal
      - default
  openwebui-sync:
    image: python:3.12-slim
    container_name: openwebui-sync
    profiles: ["tools"]
    volumes:
      - ./services/openwebui/tools:/opt/:ro
      - ./services/openwebui/data:/data
    working_dir: /opt
    entrypoint:
      - python
      - /opt/sync_openwebui_function.py
      - --script
      - /opt/reestr_openwebui.py
      - --db
      - /data/webui.db
      - --function-id
      - reestr
    depends_on:
      - openwebui
    restart: "no"
  semantic:
    image: docker.io/0x3654/gisp-semantic:latest
    container_name: semantic_service
    env_file: .env
    environment:
      - PYTHONPATH=/app
    volumes:
      - ./services/semantic/synonyms.json:/app/synonyms.json:ro
    command:
      - uvicorn
      - semantic_service:app
      - --host
      - 0.0.0.0
      - --port
      - "8010"
      - --workers
      - "2"
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    depends_on:
      - postgres_registry
    restart: unless-stopped
    networks:
      - internal
  embeddings-worker:
    build:
      context: .
      dockerfile: ./services/import/Dockerfile.embeddings
    profiles:
      - embeddings
    env_file: .env
    working_dir: /app
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    volumes:
      - .:/app
    depends_on:
      - postgres_registry
      - semantic
    networks:
      - internal
    restart: "no"
    environment:
      FORCE: ${FORCE:-0}
      DRY_RUN: ${DRY_RUN:-0}
      SOURCE_FILES: ${SOURCE_FILES:-}
      EMBED_IDS: ${EMBED_IDS:-}
      LIMIT: ${LIMIT:-}
      EXTRA_EMBED_ARGS: ${EXTRA_EMBED_ARGS:-}
      SEMANTIC_URL_OVERRIDE: ${SEMANTIC_URL_OVERRIDE:-}
      SHARD_INDEX: "0"
      SHARD_COUNT: "1"
      BATCH_SIZE: "200"
    command: >
      bash -lc "set -e;
      ./services/import/scripts/run_embeddings_worker.sh"
    deploy:
      restart_policy:
        condition: none
  starter-dump:
    image: docker.io/0x3654/gisp-starter:latest
    container_name: gisp-starter-dump
    profiles:
      - starter
    env_file: .env
    environment:
      - FORCE=${STARTER_FORCE:-0}
    depends_on:
      - postgres_registry
    restart: "no"
    networks:
      - internal
networks:
   internal:
     internal: true
   default:
    name: registry-net
    driver: bridge
